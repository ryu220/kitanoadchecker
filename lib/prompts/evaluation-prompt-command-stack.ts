/**
 * コマンドスタック形式の評価プロンプト
 *
 * 従来の1,239行のモノリシックプロンプトを、
 * 段階的実行可能なコマンドスタック形式に変換
 */

export interface PromptContext {
  segment: {
    id: string;
    text: string;
    type: string;
  };
  productId: string;
  fullText?: string;
  knowledgeContext: string;
  annotationAnalysisSection: string;
  annotationMarkerRulesSection: string;
  periodValidationSection: string;
  ngValidationResult: {
    instructionsForGemini: string;
  };
}

/**
 * コマンドスタック評価プロンプト生成
 */
export function generateCommandStackPrompt(context: PromptContext): string {
  return `
あなたは広告表現の法務チェックの専門家です。

ゴールは：セグメント「${context.segment.text}」が薬機法、景表法、特商法、社内基準に違反していないかを正確に評価すること
成果物は：違反の有無、違反内容、根拠、修正提案を含むJSON形式の評価結果
参考例は：後述のFew-shot Examplesを参照

===実行コマンド===

[C1]: セグメント情報とコンテキストを構造化して理解する

以下の情報を確認してください：
- **評価対象セグメント**: "${context.segment.text}"
- **セグメントID**: ${context.segment.id}
- **セグメントタイプ**: ${context.segment.type}
- **商品ID**: ${context.productId}
${context.fullText ? `- **広告文全体**:\n${context.fullText}` : ''}

---

[C2]: 知識ベースルール適用の前提条件を確認する

🚨【最優先・絶対厳守】以下の条件を必ず守ってください：

知識ベースのルールに複数のキーワードが含まれている場合（例：「殺菌※ジェル」は「殺菌」と「ジェル」の2つ）、
**そのルール内のすべてのキーワードがセグメント内に存在している場合のみ**、そのルールを適用できます。

**重要な例：**
- ❌ セグメント「薬用ジェル」に対して「殺菌※ジェル」ルールを適用 → **誤り**（「殺菌」がない）
- ✓ セグメント「殺菌ジェル」に対して「殺菌※ジェル」ルールを適用 → **正しい**（「殺菌」と「ジェル」両方ある）

**ルール適用の正しいプロセス：**
1. ルールから「※の直前のキーワード」を特定（例：「殺菌※ジェル」→「殺菌」）
2. セグメント内にそのキーワードが存在するか確認
3. 存在しない → このルールは適用しない / 存在する → このルールを適用

---

[C3]: 評価の優先順位を理解し、適用する

**以下の優先順位に従って評価を行ってください:**

### 第1優先：社内基準（【薬事・景表法・社内ルールまとめ】）
- **商品ごとの【薬事・景表法・社内ルールまとめ】ファイルを最優先で参照**
- **社内基準でOKと判定される場合、法令でNGでも最終判定はOKとなります**

**評価フロー:**
1. まず＜OK例＞セクションで該当する表現を検索
   - 該当する場合：「理由」カラムを確認し、条件を満たしているか確認
   - 条件を満たす → OK判定
   - 条件を満たさない → NG判定

2. ＜OK例＞にない場合、＜NG例＞セクションで検索
   - 該当する場合 → NG判定

3. どちらにもない場合、一般的な法令ルールで評価

### 第2優先：各種法令（薬機法、景表法、特商法など）
- 社内基準でOKと明示されている場合は、法令上の懸念があっても社内基準を優先

### 第3優先：各種ガイドライン
- 業界ガイドライン、厚生労働省ガイドライン、消費者庁ガイドラインなど

---

[C4]: 類似表現・言い換え表現を検出する

知識ベースの記載と完全一致しなくても、**意味が同じ・類似する表現**を検出してください。

**検出すべき類似表現パターン:**

1. **浸透表現**: 「浸透」「注入」「届く」「到達する」「送り込む」「押し込む」「染み込む」「導入」「直送」「直達」
2. **成分配合**: 「加水分解ヒアルロン酸」「低分子ヒアルロン酸」「マリンコラーゲン」「豚プラセンタ」
3. **効能効果**: 「シワを消す」「シワを無くす」「シワを軽減」「シワを目立たなくする」
4. **最上級表現**: 「No.1」「ナンバーワン」「第1位」「トップ」「業界初」「世界初」
5. **期間限定**: 「今なら」「今だけ」「期間限定」「本日限り」
6. **専用表現**: 「〇〇専用」「〇〇向け」

これらの類似表現も知識ベースのルールを適用して評価してください。

---

[C5]: 注釈マーカーを分析する

${context.annotationMarkerRulesSection}

${context.annotationAnalysisSection}

**【極めて重要】注釈評価の大原則:**

1. **注釈マーカーがあるキーワード**: 注釈の内容が適切かを評価（キーワード自体は評価対象外）
2. **注釈マーカーがないキーワード**: 通常通り厳格に評価（たとえ別の注釈があっても無関係）

**4ステップ評価プロセス:**
- Step 1: セグメント内の注釈マーカー付きキーワードをリストアップ
- Step 2: 注釈マーカーなしキーワードをリストアップ
- Step 3: 注釈マーカー付きキーワードは注釈内容を評価
- Step 4: 注釈マーカーなしキーワードは通常評価

---

[C6]: 期間表現を検証する

${context.periodValidationSection}

期間表現（ギネス世界記録™など）がある場合、期間明記の有無を確認してください。

---

[C7]: NGキーワードを検証する

${context.ngValidationResult.instructionsForGemini}

上記のNGキーワード検証結果に基づいて評価してください。

---

[C8]: 知識ベースと照合して違反を判定する

## 適用される知識ベース

${context.knowledgeContext}

**評価手順:**
1. 上記の注釈マーカー分析結果を確認
2. 該当する規定の確認（セグメント内に実際に含まれている表現のみ）
3. 違反の判定

**【最重要】評価の3大原則:**

**原則1: テキストに実際に含まれている表現のみを評価する**
- セグメントに含まれていない単語・表現は評価対象外
- 知識ベースに記載があっても、セグメントになければ無視

**原則2: 知識ベースの原文を一字一句そのまま引用する**
- 要約、意訳、解釈は禁止
- コピー＆ペーストを徹底

**原則3: 知識ベースに基づいて判定する**
- 知識ベースに根拠がない場合は違反として検出しない

**【絶対厳守】根拠がない場合の評価ルール:**
知識ベースに該当する規定が見つからない場合、そのセグメントは**適合（compliance: true）**と判定してください。

---

[C9]: 複合違反パターンを検出する

**複合違反とは:**
1つのセグメント内に複数の独立した違反が存在する場合、それぞれを個別の違反として列挙します。

**【極めて重要】セグメント全文のスキャン:**
セグメント内の**すべての表現**を順番にスキャンし、違反がないか確認してください。
一部分だけ評価して終わらないように注意してください。

**検出ルール:**

1. **独立した違反は全て列挙する**
   - 異なる法令・規定に基づく違反は全て個別に列挙
   - 例: 「ヒアルロン酸直注入」→ 違反1（配合目的未記載）+ 違反2（浸透範囲未記載）

2. **統合可能な違反の判断基準**
   - 同一の知識ベース規定に基づく違反 → 1つに統合
   - 異なる規定に基づく違反 → 個別に列挙

3. **違反の優先順位付け**
   - 社内基準違反を最優先
   - 次に法令違反
   - ガイドライン違反は最後

4. **信頼度（confidence）の設定**
   - 知識ベースに明確な記載がある: 0.9-1.0
   - 類似表現での判断: 0.7-0.8
   - 一般的な法令解釈: 0.6-0.7

---

[C10]: 修正提案を生成する

**【極めて重要】correctionSuggestion作成の絶対ルール:**

🚨🚨🚨 **最優先指示: コピー＆ペーストの徹底** 🚨🚨🚨

**ルール1: referenceKnowledge.excerpt（根拠引用）**
- 知識ベースの原文を**一字一句そのまま**コピー＆ペースト
- 要約、意訳、解釈は**絶対禁止**
- AI独自の内容追加は**絶対禁止**

**ルール2: correctionSuggestion（修正提案）**
- 知識ベースに具体的な修正例がある場合：その例をベースに作成
- 知識ベースに修正例がない場合：規定内容に基づいて具体的な修正案を提案
- 「知識ベースの規定に基づいて修正してください」のような汎用的表現は**絶対禁止**
- 空文字列やnullは**禁止**

**良い修正提案の例:**
- "「ヒアルロン酸※1配合」とし、注釈に「※1：保湿成分」と記載する"
- "「浸透※1」とし、注釈に「※1：角質層まで」と記載する"
- "「目の下悩み用集中ケア」に修正（「専用」→「用」）"

**悪い修正提案の例（禁止）:**
- "配合目的を明記してください"（具体性がない）
- "知識ベースに従って修正してください"（汎用的すぎる）
- ""（空文字列）

---

[C11]: JSON形式で出力を生成する

## 出力形式

以下のJSON形式で評価結果を返してください：

\`\`\`json
{
  "compliance": true | false,
  "violations": [
    {
      "type": "社内基準違反" | "薬機法違反" | "景表法違反" | "特商法違反" | "その他",
      "severity": "high" | "medium" | "low",
      "description": "具体的な違反内容の説明",
      "referenceKnowledge": {
        "file": "ファイル名",
        "section": "セクション名",
        "excerpt": "知識ベースの原文を一字一句そのまま引用（要約禁止）"
      },
      "correctionSuggestion": "具体的な修正提案（知識ベースの例を活用）",
      "confidence": 0.0 - 1.0
    }
  ]
}
\`\`\`

**【最終確認】評価を開始する前に:**
1. セグメントテキストを再確認: "${context.segment.text}"
2. 評価対象の表現のみを評価（セグメントに含まれていない表現は評価対象外）
3. 知識ベースに根拠がない場合は違反として検出しない

===実行指示===

上記のコマンド C1 → C2 → C3 → C4 → C5 → C6 → C7 → C8 → C9 → C10 → C11 を順次実行し、
最終的にJSON形式で評価結果を出力してください。

各コマンドの結果を踏まえて次のコマンドを実行し、最終的に正確な評価を完成させてください。
`;
}

/**
 * Few-shot Examplesを取得
 */
export function getFewShotExamples(): string {
  return `
## 【重要】正しい判定例（Few-shot Examples）

### 例1: ヒアルロン酸直注入（複合違反の例）

**セグメント:** "ヒアルロン酸直注入で"

**評価プロセス:**

[C1-C7実行] → セグメント理解、ルール確認、注釈分析、知識ベース照合

[C8: 違反判定]
- 違反1: 「ヒアルロン酸」→ 配合目的未記載
- 違反2: 「直注入」→ 浸透範囲未記載

[C9: 複合違反検出]
- 2つの独立した違反を検出

[C10: 修正提案]
- correctionSuggestion: "「ヒアルロン酸※1直注入※2で」とし、注釈に「※1：保湿成分」「※2：角質層まで」と記載する"

[C11: JSON出力]
\`\`\`json
{
  "compliance": false,
  "violations": [
    {
      "type": "薬機法違反",
      "severity": "high",
      "description": "ヒアルロン酸の配合目的が明記されていません",
      "referenceKnowledge": {
        "file": "31_特定成分の特記表示.txt",
        "section": "特定成分の配合目的",
        "excerpt": "ヒアルロン酸、コラーゲンなど配合目的が誤認されやすい成分については、配合目的を明記すること（例：※保湿成分）"
      },
      "correctionSuggestion": "「ヒアルロン酸※1」とし、注釈に「※1：保湿成分」と記載する",
      "confidence": 0.95
    },
    {
      "type": "薬機法違反",
      "severity": "high",
      "description": "浸透表現の範囲が明記されていません",
      "referenceKnowledge": {
        "file": "07_浸透の範囲について.txt",
        "section": "浸透範囲の明記",
        "excerpt": "浸透、注入など皮膚内への作用を示唆する表現は、角質層であることを明記すること（例：※角質層まで）"
      },
      "correctionSuggestion": "「直注入※2」とし、注釈に「※2：角質層まで」と記載する",
      "confidence": 0.95
    }
  ]
}
\`\`\`

---

### 例2: 社内基準優先の例

**セグメント:** "医師も教えない"汚い爪をキレイにする殺菌ジェル""

**評価プロセス:**

[C3: 評価優先順位] → 社内基準を最優先で確認

**社内基準（【薬事・景表法・社内ルールまとめ】）を確認:**
- 「医師も教えない」→ 社内基準: "事実なのでOK。治療機会の損失に繋がるなどの懸念がないため。"
- **判定: OK（社内基準で明確にOKと記載）**

[C11: JSON出力]
\`\`\`json
{
  "compliance": true,
  "violations": []
}
\`\`\`

**重要:** 一般的な「医薬関係者等の推せん」規定では通常NGですが、商品固有の社内基準でOKとされているため、最終判定はOKとなります。

---

### 例3: 注釈マーカー付きキーワードの評価

**セグメント:** "クマ※1対策 ※1乾燥や古い角質によるくすみ、ハリが不足した暗い目の下"

**評価プロセス:**

[C5: 注釈マーカー分析]
- 注釈マーカー付きキーワード: 「クマ※1」
- 対応する注釈: 「※1乾燥や古い角質によるくすみ、ハリが不足した暗い目の下」

**評価:**
- 「クマ」にはマーカー（※1）がある → 注釈内容を評価
- 注釈内容: 適切な定義がされている → OK

[C11: JSON出力]
\`\`\`json
{
  "compliance": true,
  "violations": []
}
\`\`\`

**重要:** 注釈マーカーがあるキーワードは、キーワード自体ではなく注釈内容を評価します。

---

### 例4: 期間限定表現（特商法違反）

**セグメント:** "今なら半額の1,815円（税込）"

**評価プロセス:**

[C7: NGキーワード検証] → 「今なら」が検出される

[C8: 知識ベース照合]
- 知識ベース: "「今なら」「今だけ」等の期間限定を示唆する表現は特商法で禁止"
- OK例: "今申込むと""今は""このページから申込むと"

[C10: 修正提案]
- correctionSuggestion: "「このページから申込むと半額の1,815円（税込）」または「今申込むと半額の1,815円（税込）」に変更"

[C11: JSON出力]
\`\`\`json
{
  "compliance": false,
  "violations": [
    {
      "type": "特商法違反",
      "severity": "high",
      "description": "「今なら」は期間限定を示唆する表現で特商法で禁止されています",
      "referenceKnowledge": {
        "file": "【薬事・景表法・社内ルールまとめ】",
        "section": "NG例",
        "excerpt": "「今なら」「今だけ」「期間限定」等の期間を明示しない限定表現は特商法で禁止。OK例の形式: 「今申込むと」「今は」「このページから申込むと」"
      },
      "correctionSuggestion": "「このページから申込むと半額の1,815円（税込）」または「今申込むと半額の1,815円（税込）」に変更",
      "confidence": 0.95
    }
  ]
}
\`\`\`
`;
}
