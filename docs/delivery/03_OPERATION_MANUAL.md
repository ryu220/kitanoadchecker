# 運用マニュアル - 広告文リーガルチェックツール

**対象**: 日常業務での使用方法
**バージョン**: v1.0
**最終更新**: 2025年10月30日

---

## 📋 目次

1. [基本的な使い方](#基本的な使い方)
2. [商品の選択](#商品の選択)
3. [判定結果の見方](#判定結果の見方)
4. [修正作業の進め方](#修正作業の進め方)
5. [よくある判定パターン](#よくある判定パターン)
6. [API経由での使用](#api経由での使用)
7. [ナレッジの追加・更新](#ナレッジの追加更新)
8. [よくある質問](#よくある質問)

---

## 基本的な使い方

### 📱 Web UIでの使用

#### Step 1: アクセス

**開発環境**:
```
http://localhost:3000
```

**本番環境（Railway）**:
```
https://your-app.railway.app
```

#### Step 2: 商品を選択

商品選択ドロップダウンから対象商品を選択します。

| 商品タイプ | 選択肢 |
|----------|-------|
| **高度対応商品** | HA（ヒアロディープパッチ）、SH（クリアストロングショット） |
| **基本対応商品** | その他40商品 |

#### Step 3: 広告文を入力

テキストエリアに広告文を入力します。

**入力例**:
```
医師も教えない"汚い爪をキレイにする殺菌ジェル"

累計250万本突破！

Amazon・楽天で1位を獲得した人気商品です。

浸透して原因菌を殺菌。爪を清潔に保ちます。

全額返金保証も付いて安心です。
```

#### Step 4: 判定実行

「判定実行」ボタンをクリックします。

**処理時間**: 通常10-30秒（広告文の長さにより変動）

#### Step 5: 結果確認

セグメントごとに判定結果が表示されます。

---

## 商品の選択

### 🎯 商品タイプ別の違い

#### 高度対応商品（HA / SH）

| 特徴 | 内容 |
|------|------|
| **専用ナレッジ** | 商品専用のルールファイルあり |
| **高精度** | 商品特有の表現を詳細にチェック |
| **ナレッジ数** | HA: 11ファイル、SH: 8ファイル + 共通100+ |
| **例** | 「ニードル技術」（HA特有）、「爪水虫」（SH特有） |

**推奨用途**: HA, SH商品の広告文チェック

#### 基本対応商品（その他40商品）

| 特徴 | 内容 |
|------|------|
| **共通ナレッジ** | 薬機法・景表法・社内ルールの共通チェック |
| **標準精度** | 一般的な違反を検出 |
| **ナレッジ数** | 共通100+ファイル |
| **例** | 「殺菌」「浸透」「1位」等の一般的NGワード |

**推奨用途**: HA, SH以外の商品の広告文チェック

### 商品選択の注意点

⚠️ **重要**: 商品を間違えると誤判定の可能性があります

- HA商品の広告文 → **HA** を選択
- SH商品の広告文 → **SH** を選択
- その他の商品 → **該当する商品コード** を選択

---

## 判定結果の見方

### 判定の種類

| 判定 | 意味 | 表示色 |
|------|------|--------|
| **適合** | 問題なし | 緑 |
| **不適合** | 法令違反・リスクあり | 赤/黄 |

### 不適合の詳細

#### 重大度レベル

| レベル | 意味 | 対応 |
|--------|------|------|
| **重大** | 法令違反の可能性が高い | **必ず修正** |
| **中程度** | リスクあり | 修正推奨 |
| **軽度** | 注意が必要 | 検討 |

#### 違反タイプ

| タイプ | 説明 | 例 |
|--------|------|---|
| **薬機法違反** | 医薬品医療機器等法違反 | 「治る」「効く」「殺菌」 |
| **景表法違反** | 不当景品類及び不当表示防止法違反 | 「1位」（エビデンス不足） |
| **社内ルール違反** | 会社の自主規制ルール | 注釈漏れ |

### 判定結果の構成

```
セグメント 1
不適合
----------------------------------------
【検出されたテキスト】
Amazon・楽天で1位を獲得した人気商品です。

【違反内容】
景表法違反（重大）
ランキング・順位表現には景表法により調査機関・調査期間・
調査対象を明記したエビデンスが必須です

【検出されたキーワード】
「1位」

【根拠ナレッジ】
knowledge/common/37_エビデンス表記について.txt

【修正案】
Amazon・楽天で1位※を獲得した人気商品です。
※2024年1月Amazon・楽天ランキング調査
```

---

## 修正作業の進め方

### 🔧 推奨ワークフロー

#### ステップ1: 全体を確認

- 不適合セグメントの数を確認
- 重大度「重大」のセグメントを優先

#### ステップ2: 重大度「重大」から修正

**例**: ランキング表現（エビデンス不足）

**修正前**:
```
Amazon・楽天で1位を獲得した人気商品です。
```

**修正後**:
```
Amazon・楽天で1位※を獲得した人気商品です。
※2024年1月Amazon・楽天ランキング調査
```

#### ステップ3: 中程度・軽度を検討

**例**: 保証表現

**修正前**:
```
全額返金保証も付いて安心です。
```

**修正後（画像・動画の場合）**:
```
全額返金保証※も付いて安心です。
※詳細は遷移先ページに記載
```

**修正後（広告文の場合）**:
```
全額返金保証も付いて安心です。
（遷移先ページに詳細記載があればOK）
```

#### ステップ4: 再チェック

修正後の広告文を再度チェックします。

---

## よくある判定パターン

### 🔴 パターン1: ランキング表現

#### 検出される表現

| 表現 | 理由 |
|------|------|
| 「1位」「第1位」 | エビデンスが必須（景表法） |
| 「NO.1」「No.1」 | エビデンスが必須 |
| 「トップ」（ランキング文脈） | エビデンスが必須 |

#### 修正方法

**必須要素**:
1. 調査機関（Amazon、楽天、自社調べ 等）
2. 調査期間（2024年1月 等）
3. 調査対象（当社商品、化粧品部門 等）

**OK例**:
```
Amazon・楽天で1位※を獲得
※2024年1月Amazon・楽天ランキング調査
```

**NG例**:
```
Amazon・楽天で1位を獲得  （エビデンス不足）
```

### 🔴 パターン2: 浸透表現

#### 検出される表現

| 表現 | 理由 |
|------|------|
| 「浸透」 | 範囲の明示が必須（薬機法） |

#### 修正方法

**SH商品の場合**:
```
浸透※して原因菌を殺菌
※背爪表面に
```

**HA商品の場合**:
```
浸透※してヒアルロン酸を届ける
※角層まで
```

**化粧品の場合**:
```
浸透※してうるおいを与える
※角層まで
```

### 🔴 パターン3: 殺菌表現

#### 検出される表現

| 表現 | 理由 |
|------|------|
| 「殺菌」 | 作用機序の明示が必須（SH商品） |

#### 修正方法

**SH商品（医薬部外品）の場合**:
```
殺菌※ジェル
※殺菌は消毒の作用機序として
```

### 🔴 パターン4: 保証表現

#### 検出される表現

| 表現 | 理由 |
|------|------|
| 「全額返金保証」 | 条件の明示が必須 |

#### 修正方法

**画像・動画内の場合**:
```
全額返金保証※
※詳細は遷移先ページに記載
```

**広告文の場合**:
```
全額返金保証
（遷移先ページに詳細があればOK）
```

### 🔴 パターン5: クマ表現

#### 検出される表現

| 表現 | 判定 |
|------|------|
| 「クマ」単体 | NG |
| 「目元のクマ」 | OK |
| 「クマができる」 | OK（文脈依存） |

#### 修正方法

**NG例**:
```
クマに悩む方へ  （部位不明）
```

**OK例**:
```
目元のクマに悩む方へ
```

---

## API経由での使用

### 📡 API エンドポイント

#### 1. セグメント分割API

**エンドポイント**: `POST /api/v2/segment`

**リクエスト**:
```json
{
  "text": "Amazon・楽天で1位を獲得した人気商品です。",
  "productId": "SH",
  "apiKey": "your-api-key"
}
```

**レスポンス**:
```json
{
  "segments": [
    {
      "id": "segment-1",
      "text": "Amazon・楽天で1位を獲得した人気商品です。",
      "type": "explanation",
      "position": {
        "start": 0,
        "end": 28,
        "line": 1
      }
    }
  ]
}
```

#### 2. 評価API

**エンドポイント**: `POST /api/v2/evaluate-batch`

**リクエスト**:
```json
{
  "segments": [
    {
      "id": "seg-1",
      "text": "Amazon・楽天で1位を獲得した人気商品です。",
      "type": "explanation"
    }
  ],
  "productId": "SH",
  "apiKey": "your-api-key"
}
```

**レスポンス**:
```json
{
  "results": [
    {
      "segmentId": "seg-1",
      "isCompliant": false,
      "violations": [
        {
          "type": "景表法違反",
          "severity": "重大",
          "description": "ランキング・順位表現には...エビデンスが必須",
          "suggestion": "Amazon・楽天で1位※を獲得...",
          "referenceKnowledge": "knowledge/common/37_..."
        }
      ]
    }
  ]
}
```

#### 3. レポート生成API

**エンドポイント**: `POST /api/v2/report`

**リクエスト**:
```json
{
  "fullText": "広告文全文...",
  "results": [ /* evaluate-batchの結果 */ ],
  "productId": "SH"
}
```

**レスポンス**:
```json
{
  "report": "# 広告文チェックレポート\n\n## 総合判定: 不適合\n\n...",
  "summary": {
    "totalSegments": 5,
    "compliantSegments": 2,
    "nonCompliantSegments": 3,
    "criticalViolations": 2,
    "moderateViolations": 1
  }
}
```

---

## ナレッジの追加・更新

### 📚 ナレッジファイルの構造

```
knowledge/
├── common/         # 全商品共通のルール
│   ├── 01_薬事に関する資料.txt
│   ├── 02_プラスで確認すべき薬事関連情報.txt
│   └── ...（100+ファイル）
├── HA/            # HA商品専用ルール
│   ├── 55_【薬事・景表法】ヒアロディープパッチ.txt
│   └── ...（11ファイル）
└── SH/            # SH商品専用ルール
    ├── 77_【薬事・景表法】クリアストロングショット.txt
    └── ...（8ファイル）
```

### ナレッジ追加手順

#### Step 1: ファイル作成

```bash
# 共通ルールの場合
cd knowledge/common/
nano 新しいルール.txt

# 商品専用ルールの場合
cd knowledge/HA/  # または SH/
nano 商品専用ルール.txt
```

#### Step 2: 優先度設定

`config/knowledge-priority-mapping.csv` に追加:

```csv
ファイルパス,優先度
knowledge/common/新しいルール.txt,5
```

**優先度**:
- 10: 最高（商品専用ルール）
- 5: 高（重要な共通ルール）
- 3: 中（一般的なルール）
- 1: 低（参考情報）

#### Step 3: Vector DB更新

```bash
# ナレッジベースを再構築
npm run setup:vector-db
```

#### Step 4: 動作確認

Web UIまたはAPIでテスト広告文を実行し、新しいルールが適用されるか確認します。

---

## よくある質問

### Q1: 判定に時間がかかる

**A**: 以下の要因が考えられます:

- **広告文が長い**: セグメント数が多いほど時間がかかります
- **Gemini API のレート制限**: 一時的に遅延する場合があります
- **ChromaDB の応答遅延**: Vector検索に時間がかかる場合があります

**対策**:
- 広告文を分割して判定
- 時間をおいて再実行

### Q2: エラーが発生する

**A**: エラーメッセージを確認してください:

| エラー | 原因 | 対策 |
|--------|------|------|
| `ChromaDB connection failed` | ChromaDBが起動していない | `docker-compose up -d chroma` |
| `Gemini API error` | APIキーが無効 | `.env` の `GEMINI_API_KEY` を確認 |
| `Knowledge base not found` | Vector DBが未初期化 | `npm run setup:vector-db` |

### Q3: 判定結果が期待と異なる

**A**: 以下を確認してください:

1. **商品選択が正しいか**: HA商品なのにSHを選択していないか
2. **ナレッジが最新か**: 最新のルールが反映されているか
3. **表現が曖昧か**: AIが判断しにくい表現の場合があります

**対策**:
- 商品を正しく選択
- ナレッジを更新（`npm run setup:vector-db`）
- 表現を明確にする

### Q4: 新しい商品を追加したい

**A**: 以下の手順で追加できます:

1. `config/products/新商品.json` を作成
2. `knowledge/新商品/` ディレクトリを作成し、ルールファイルを追加
3. `config/knowledge-priority-mapping.csv` に優先度を設定
4. Vector DBを更新（`npm run setup:vector-db`）
5. フロントエンドの商品選択肢に追加

詳細は `docs/PRODUCT_ADDITION_GUIDE.md` を参照してください。

---

## 📞 サポート

### 問い合わせ先

- **GitHub Issues**: https://github.com/ryu220/kitanoadchecker/issues
- **ドキュメント**: `docs/delivery/` ディレクトリ

### 関連ドキュメント

| ドキュメント | 内容 |
|------------|------|
| `01_OVERVIEW.md` | システム概要 |
| `02_SETUP_GUIDE.md` | セットアップ手順 |
| `06_TROUBLESHOOTING.md` | トラブルシューティング |
| `RESTORE_POINT_20251030.md` | システム復元ポイント |

---

**作成日**: 2025年10月30日
**対象バージョン**: v1.0
**最終更新**: 運用マニュアル確定
